# 001.001 — Оркестрация релиз-трейна до готовности к срезу

## Цель
Реализовать автономный поток от планового старта релиз-трейна до шага, где все команды подтвердили готовность к срезу.

## Ожидаемые артефакты CrewAI
- `agents`:
  - `orchestrator` (планирование, маршрутизация, контроль состояния);
  - `release_manager` (операции конкретного релиза `X.Y.Z`).
- `tasks`:
  - `start_release_train`;
  - `confirm_or_update_version`;
  - `create_crosspace_release`;
  - `announce_kickoff_meeting`;
  - `collect_readiness_statuses`.
- `tools` (контракты):
  - Slack: `slack_events`, `slack_message`, `slack_approve`, `slack_update`;
  - JIRA: `create_crosspace_release`;
  - системный: heartbeat trigger.
- `knowledge/memory`:
  - persistent storage для workflow-state (активный и предыдущий релиз).

## Границы задачи
- Включено:
  - старт релиз-трейна по расписанию через `Orchestrator`;
  - подтверждение/корректировка версии в Slack;
  - создание агента `Release Manager X.Y.Z`;
  - создание cross-space release в JIRA;
  - публикация статусов готовности по командам и обновление статусов в одном сообщении.
- Не включено:
  - отведение релизной ветки;
  - запуск build RC;
  - завершение релиза и очистка памяти.

## Зависимости и входные данные
- Конфиги:
  - список проектов JIRA для cross-space release;
  - канал Slack для релиз-коммуникации;
  - heartbeat интервал (`15 минут`, `4 часа`);
  - timezone (`Europe/Moscow`);
  - доступ к памяти CrewAI.
- Интеграции:
  - `slack_approve`, `slack_update`, `slack_message`, `slack_events`;
  - `create_crosspace_release`;
  - heartbeat для периодического запуска `Orchestrator` по конфигурируемому интервалу.

## Контракт состояния (state machine)
- `IDLE` -> `WAIT_START_APPROVAL` -> `RELEASE_MANAGER_CREATED` -> `JIRA_RELEASE_CREATED` -> `WAIT_MEETING_CONFIRMATION` -> `WAIT_READINESS_CONFIRMATIONS` -> `READY_FOR_BRANCH_CUT`.
- Для каждого перехода хранить:
  - `release_version`;
  - `step`;
  - `updated_at`;
  - `slack_channel_id`;
  - `message_ts/thread_ts` для сообщений, которые обновляются;
  - `readiness_map` по командам.

## Подзадачи реализации
1. Реализовать расписание старта релиз-трейна (пятница, 11:00 МСК) и переход из idle в workflow старта.
2. Реализовать heartbeat-триггер `Orchestrator` с поддержкой интервалов из конфига (`15 минут`, `4 часа`) и корректной обработкой состояния idle.
3. Реализовать шаг подтверждения версии:
   - базовый расчет версии (инкремент `Y` от предыдущего релиза);
   - обработка альтернативной версии из треда;
   - обновление approve-сообщения с новой версией.
4. После подтверждения создавать `Release Manager X.Y.Z` и сохранять связь с активным трэйном.
5. Добавить создание релиза в JIRA через `create_crosspace_release` с проектными релизами версии `X.Y.Z`.
6. Отправлять сообщение о встрече фиксации релиза с JQL-ссылкой и ожидать подтверждение `"Провели"`.
7. Публиковать сообщение готовности к срезу по командам, слушать ответы в треде и обновлять статус каждой команды:
   - `:hourglass_flowing_sand:` -> `:white_check_mark:`.

## Идемпотентность и надежность (обязательно)
- Повторный heartbeat не должен дублировать side effects:
  - если approve-сообщение уже создано, только читать/проверять статус;
  - если релиз в JIRA уже создан для `X.Y.Z`, не создавать повторно;
  - если статус команды уже `white_check_mark`, не откатывать назад.
- Все внешние вызовы делать через retriable-обертку:
  - bounded retries + backoff;
  - логирование ошибки с контекстом `release_version`, `step`, `tool`.
- На каждый шаг фиксировать checkpoint в memory до и после вызова внешнего инструмента.

## Observability (tracing + logs)
- Включить CrewAI tracing для каждого task run.
- Минимальные поля структурного лога:
  - `trace_id`, `release_version`, `agent`, `task`, `step`, `tool`, `result`, `latency_ms`.
- Метрики для дашборда:
  - время прохождения шагов;
  - количество ретраев по интеграциям;
  - число активных релиз-трейнов.

## Тест-план
- Unit:
  - расчет версии (`Y` increment);
  - парсинг альтернативной версии из треда;
  - переходы state machine.
- Integration (mock tools):
  - happy-path от старта до `READY_FOR_BRANCH_CUT`;
  - повторный heartbeat не создает дубликатов;
  - падение Slack/JIRA обрабатывается retry-механикой.
- E2E (staging):
  - запуск в тестовом Slack-канале и верификация обновления одного и того же сообщения статусов.

## Критерии готовности (DoD)
- В пятницу в 11:00 МСК автоматически создается approve-запрос на старт релиза.
- Если в треде предложен другой номер версии, система принимает его и использует во всех следующих шагах.
- Heartbeat использует значения из конфига (`15 минут`, `4 часа`) и не привязан к одному хардкод-интервалу.
- После подтверждения создается `Release Manager` и релизный артефакт в JIRA.
- Сообщение о готовности к срезу обновляется инкрементально по мере ответов команд в треде.
- Состояние шага и текущая версия сохраняются в памяти и доступны после перезапуска процесса.
- Повторный запуск на том же шаге не приводит к дублям сообщений/релизов.
- Логи и trace позволяют восстановить цепочку действий по `trace_id`.

## Как запускать задачу отдельно
- Достаточно иметь:
  - рабочий heartbeat/trigger `Orchestrator` с настроенными интервалами `15 минут` и `4 часа`;
  - подключенные Slack + JIRA интеграции;
  - тестовый релизный канал в Slack.
- Проверка изолированно:
  - запустить workflow старта релиза;
  - вручную пройти подтверждения в тредах;
  - убедиться, что шаг завершается состоянием `READY_FOR_BRANCH_CUT`.

## Definition of Ready
- Зафиксированы tool contracts (payload и ожидаемые ответы).
- Подготовлены тестовые Slack/JIRA окружения.
- Определены обязательные поля memory-схемы для релиза.
