# Описание целевого вида системы для итерации 1

## Цель
Создать систему из агентов, которая управляет процессом релиз трейна. Система знает о всех текущих блокерах релиза, взаимодействует с сотрудниками людьми через Slack

## Архитектура

Проект строится на базе фреймворка CrewAI. Система состоит из следующих агентов:

1. Orchestrator. Знает, когда нужно стартовать новый релиз трейн, когда заканчивается предыдущий. Запускает релиз-трейны. Цель: координировать работу между релиз трейнами

2. Release Manager X. На каждый релиз создается новый агент, который занимается конкретным релизом, к примеру "Release Manager 5.100.0". Цель: пройти процесс релиз-трейна, взаимодействовать с сотрудниками в компании через Slack, чтобы синхронизироваться по статусам

## Инструменты
- Агенты используют CrewAI memory для сохранения информации по текущему состоянию. Важна информацию по активному и предыдущему релиз-трейнам
- Используется CrewAI tracing для логирования действий системы

## Интеграции
- Slack events - получение событий из слака по каналу X, в том числе и по активностям в тредах канала
- Slack slack_message - отправление сообщения в канал X или в тред Y. с возможностью упоминать @mention
- Slack slack_reaction - ставит эмоджик на сообщение X
- Slack slack_approve - отправление запроса на подтверждение действия
- Slack slack_update - обновление сообщения Х
- JIRA create_crosspace_release - создает релиз в Plans > Cross-space releases с линками на релизы проектов
- Heartbeat - каждые 15 минут дергается Orchestrator для проверки, нужно ли что-то сделать в случае если сейчас в состоянии idle.
- Github github_action - запуск Github action

## Конфигурации
- Проекты в JIRA, которые участвуют в релизах. Используется для ссылок на их релизы при создании Cross-space release
- Канал в слаке, где происходит вся коммуникация по релизу
- Github Repo - гитхаб проект, где настроены Action для запуска
- Heartbeat интервал (15 минут, 4 часа)

## Flow

### Плановый релиз
1. Orchestrator в пятницу в 11:00 по московскому времени стартует новый релиз трейн: запрашивает в слак канале подтверждение на старт трейна с номером X.Y.Z, используя slack_approve: "Подтвердите старт релизного трейна X.Y.Z. Если нужен другой номер для релиза, напишите в треде." - "Подтвердить".
1.1 X.Y.Z считается исходя из номера прошлого релиза. С каждым релизом меняется Y число. К примеру, было 5.100.0, стало 5.101.0
1.2 Если сотрудник написал в тред другую версию X.Y.Z, тогда обнови сообщение - "Подтвердите старт релизного трейна _новый_номер_. Если нужен другой номер для релиза, напишите в треде." В следующих шагах используй новый номер.

2. Orchestrator после получения подтверждения создает новый агент "Release Manager X.Y.Z".

3. Release Manager создает в JIRA релизный артефакт, используя create_crosspace_release. К релизу крепятся все существующие релизы указанных проектов с версией X.Y.Z

4. Release Manager пишет в слак канал сообщение с ожиданием подтверждения "Проведите встречу фиксации релиза. <https://instories.atlassian.net/issues/?jql=JQL|Ссылка на релизные задачи>. В 15:00 будет код-фриз." - "Провели". Где JQL строится по формату `fixVersion = X.Y.Z ORDER BY project ASC, type DESC, key ASC`

5. Release Manager после подтверждения проведения встречи ожидает, когда все команды будут готовы ко срезу. Для этого Release Manager пишет
"""
Релиз <https://instories.atlassian.net/issues/?jql=JQL|X.Y.Z>

Статус готовности к срезу:
:hourglass_flowing_sand: Growth @Мурат Камалов
:hourglass_flowing_sand: Core @Антон Давыдов
:hourglass_flowing_sand: AutoCut @Кирилл Горбачёнок
:hourglass_flowing_sand: AI Tools @Макс Адамян
:hourglass_flowing_sand: Activation @Евгений Кулинич
:hourglass_flowing_sand: Влит релиз Движка в dev @Павел Кряжевских
:hourglass_flowing_sand: Влит релиз FeaturesKit в dev @Кирилл Горбачёнок

Напишите в треде по готовности своей части.
**Важное напоминание** – все задачи, не влитые в ветку RC до 15:00 МСК едут в релиз только после одобрения QA
"""
Где каждый @ - это mention. Ожидается, что в треде сотрудник будет писать, когда будут готовы. К примеру, "growth готов"

5.1 С каждым потверждением в треде к сообщению обновляй сообщение. Меняй :hourglass_flowing_sand: на :white_check_mark:

6. После того, как все подтвердили Release Manager вызывает github_action "Create Release Branch" с параметрами { version: "X.Y.Z" }, где X.Y.Z - версия релиза. И пишет сообщение в слак с ожиданием потверждения
"""
Я запустил отведение ветки. По завершению проверь, что
- При наличии в diff новых превью шрифтов в FontThumbnailManager.Spec инкрементирована version
- В L10n.extension.swift нет временной локализации
- В TestTemplates.swift нет шаблонов
""" - "Подтвердить"

7. После подтверждения Release Manager вызывает github_action "Build RC" с параметрами { is_test: true }. И пишет сообщение в слак
"""
Я запустил сборку релиза. Ожидайте отбивки в #testflight-notifications.
Контент команда - можно выгружать контент в админку, начинать работу над сортировкой.
QA команда - можно начинать регресс.
"""

8. Release Manager ожидает сообщения в слаке с информацией, что релизная сборка готова к отправке. После этого Orchestrator сохраняет знание, что релиз завершился в дату X. Release Manager больше не нужен


## Поведение при перезапуске
Важно чтобы при перезапуске система восстанавливала контекст. И могла продолжить с последнего шага.

## Очищение памяти
Важно сохранять информацию по активному релизу, что в работе. И по предыдущему. Память о предыдущих релизах можно стирать, чтобы не засорять контекст