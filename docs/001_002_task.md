# 001.002 — Отведение ветки, сборка RC и завершение релиз-трейна

## Цель
Реализовать этап после подтверждения готовности команд: отведение релизной ветки, запуск RC-сборки, фиксацию завершения релиза и корректное восстановление состояния после перезапуска.

## Ожидаемые артефакты CrewAI
- `agents`:
  - `release_manager` (операции post-cut для конкретного релиза);
  - `orchestrator` (контроль жизненного цикла и закрытие трейна).
- `tasks`:
  - `create_release_branch`;
  - `await_branch_cut_checklist_approval`;
  - `build_rc`;
  - `await_build_ready_signal`;
  - `finalize_release_train`.
- `tools` (контракты):
  - GitHub: `github_action`;
  - Slack: `slack_message`, `slack_approve`, `slack_events`;
  - системный: heartbeat trigger.
- `knowledge/memory`:
  - persistent workflow-state + финальный summary по релизу.

## Границы задачи
- Включено:
  - запуск `github_action` для `Create Release Branch`;
  - запрос подтверждения после отведения ветки;
  - запуск `github_action` для `Build RC` (`is_test: true`);
  - информирование Slack-канала о старте сборки;
  - обработка сигнала о готовности сборки и завершение релиза;
  - политика памяти (активный + предыдущий релиз) и resume после рестарта.
- Не включено:
  - старт релиза, выбор версии и JIRA release (это задача `001_001_task.md`).

## Зависимости и входные данные
- На входе: workflow находится в состоянии `READY_FOR_BRANCH_CUT` и знает `X.Y.Z`.
- Конфиги:
  - heartbeat интервал (`15 минут`, `4 часа`).
- Интеграции:
  - `github_action`;
  - `slack_message`, `slack_approve`, `slack_events`;
  - heartbeat для запуска периодических проверок `Orchestrator`;
  - память CrewAI для статуса шага и контекста релиза.

## Контракт состояния (state machine)
- `READY_FOR_BRANCH_CUT` -> `BRANCH_CUT_IN_PROGRESS` -> `WAIT_BRANCH_CHECKLIST_APPROVAL` -> `RC_BUILD_IN_PROGRESS` -> `WAIT_BUILD_READY_SIGNAL` -> `COMPLETED`.
- Для каждого перехода хранить:
  - `release_version`;
  - `step`;
  - `updated_at`;
  - `github_action_run_id`;
  - `slack_channel_id`;
  - `message_ts/thread_ts`.

## Подзадачи реализации
1. Реализовать шаг `Create Release Branch`:
   - вызвать `github_action("Create Release Branch", { version: "X.Y.Z" })`;
   - отправить checklist-сообщение в Slack и ожидать `"Подтвердить"`.
2. После подтверждения вызвать `github_action("Build RC", { is_test: true })`.
3. Отправить сообщение в Slack о старте сборки и готовности команд (контент/QA).
4. Слушать событие о готовности релизной сборки и переводить трейн в `COMPLETED`.
5. Добавить периодические heartbeat-проверки для long-running этапов (ожидание подтверждения и ожидание сигнала о готовности сборки) с использованием интервалов из конфига.
6. После завершения:
   - зафиксировать дату завершения релиза в знаниях `Orchestrator`;
   - деактивировать `Release Manager` текущего релиза.
7. Реализовать восстановление после перезапуска:
   - поднимать workflow с последнего сохраненного шага;
   - не дублировать уже отправленные сообщения/действия.
8. Реализовать очистку памяти:
   - хранить активный и предыдущий релизы;
   - удалять более старые релизы из контекста.

## Идемпотентность и надежность (обязательно)
- Повторный heartbeat не должен повторно запускать:
  - `Create Release Branch`, если уже есть `github_action_run_id`;
  - `Build RC`, если запуск уже создан и в статусе in_progress/completed.
- Дедупликация inbound Slack events:
  - хранить `event_id/ts` обработанных событий;
  - повторно пришедшие события игнорировать.
- На external call использовать bounded retries + backoff + timeout.
- На каждый переход шага сохранять checkpoint в memory.

## Observability (tracing + logs)
- Включить CrewAI tracing на все post-cut задачи.
- Обязательные поля логов:
  - `trace_id`, `release_version`, `step`, `github_action_run_id`, `tool`, `result`, `latency_ms`.
- Отдельные алерты:
  - долгое ожидание подтверждения checklist;
  - долгое ожидание сигнала о готовности сборки;
  - повторяющиеся ошибки при вызове GitHub Action.

## Тест-план
- Unit:
  - переходы state machine post-cut этапа;
  - дедупликация Slack events;
  - проверка guard-условий идемпотентности.
- Integration (mock tools):
  - happy-path от `READY_FOR_BRANCH_CUT` до `COMPLETED`;
  - повторный heartbeat не запускает action повторно;
  - временная недоступность GitHub/Slack обрабатывается retry-механикой.
- E2E (staging):
  - реальный запуск `Create Release Branch` и `Build RC`;
  - завершение workflow по входящему событию о готовности сборки.

## Критерии готовности (DoD)
- Ветка релиза отводится только после подтвержденной готовности всех команд.
- RC-сборка запускается строго после подтверждения checklist-сообщения.
- По сигналу о готовности сборки релиз корректно закрывается и сохраняется как предыдущий.
- Heartbeat-проверки используют значения из конфига (`15 минут`, `4 часа`) без хардкода.
- После рестарта система продолжает с последнего шага без повторных side-effect действий.
- В памяти одновременно остаются только активный и предыдущий релизы.
- Повторный запуск того же шага не приводит к дублирующим `github_action` вызовам.
- Логи и trace позволяют восстановить путь выполнения по `trace_id`.

## Как запускать задачу отдельно
- Подготовить входной контекст:
  - `current_release_version = X.Y.Z`;
  - `state = READY_FOR_BRANCH_CUT`;
  - настроенные heartbeat-интервалы `15 минут` и `4 часа`;
  - валидные интеграции GitHub и Slack.
- Проверка изолированно:
  - вручную запустить шаг отведения ветки;
  - подтвердить переход к `Build RC`;
  - эмулировать событие готовности сборки;
  - проверить финальный статус и политику памяти.

## Definition of Ready
- Зафиксированы контракт и SLA по сигналу готовности сборки.
- Согласован mapping статусов GitHub Action -> внутренние состояния workflow.
- Подготовлены тестовые каналы/интеграции для безопасного staging-прогона.
